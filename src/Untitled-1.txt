import * as React from 'react';
import Modal from 'react-responsive-modal';
import './App.css';
import MemeDetail from './components/MemeDetail';
import MemeList from './components/MemeList';
import TTVlogo from './TTVlogo.gif';


const apiUrl =  'https://tedtalkapi.azurewebsites.net/api';
				
interface IState {
	currentTedTalk: any,
	tedTalks: any[],
	open: boolean,
	uploadFileList: any,
}

class App extends React.Component<{}, IState> {
	constructor(props: any) {
        super(props)
        this.state = {
			currentTedTalk: {"id":0, "title":"Loading ","url":"","tags":"⚆ _ ⚆","uploaded":"","width":"0","height":"0"},
			open: false,
			tedTalks: [],
			uploadFileList: null
		}     
		
		this.fetchTedTalks("")
		this.selectNewMeme = this.selectNewMeme.bind(this)
		this.handleFileUpload = this.handleFileUpload.bind(this)
		this.fetchTedTalks = this.fetchTedTalks.bind(this);
		this.uploadMeme = this.uploadMeme.bind(this)
		
	}

	public render() {
		const { open } = this.state;
		return (
		<div>
			<div className="header-wrapper">
				<div className="container header">
					<img src={TTVlogo} height='80'/>
					<div className="btn btn-primary btn-action btn-add" onClick={this.onOpenModal}>Add Ted Talk</div>
				</div>
				<div className="header">View your favourite Ted Talks here!</div>
				
			</div>
			<div className="container">
				<div className="row">
					<div className="col-7">
						<MemeDetail currentMeme={this.state.currentMeme} />
					</div>
					<div className="col-5">
						<MemeList memes={this.state.tedTalks} selectNewMeme={this.selectNewMeme} searchByTag={this.fetchTedTalks}/>
					</div>
				</div>
			</div>
			<Modal open={open} onClose={this.onCloseModal}>
				<form>
					<div className="form-group">
						<label>Title:</label>
						<input type="text" className="form-control" id="ted-title-input" placeholder="Enter Title" />
					</div>
					<div className="form-group">
						<label>URL:</label>
						<input type="text" className="form-control" id="ted-url-input" placeholder="Enter URL" />
						<small className="form-text text-muted">This is the YouTube link to the video</small>
					</div>
					<div className="form-group">
						<label>Topic:</label>
						<input type="text" className="form-control" id="ted-topic-input" placeholder="Enter the topic of the talk" />
						<small className="form-text text-muted">Adding a topic can help make searching easier</small>
					</div>
					<div className="form-group">
						<label>Speaker:</label>
						<input type="text" className="form-control" id="ted-speaker-input" placeholder="Enter the Speaker's name" />
						<small className="form-text text-muted">Adding the speaker's name can help make searching easier</small>
					</div>

					<button type="button" className="btn" onClick={this.uploadMeme}>Add Video</button>
				</form>
			</Modal>
		</div>
		);
	}

	// private onButtonPress = () => {
	// 	this.fetchTedTalks();
	// }

	// Modal open
	private onOpenModal = () => {
		this.setState({ open: true });
	  };
	
	// Modal close
	private onCloseModal = () => {
		this.setState({ open: false });
	};
	
	// Change selected meme
	private selectNewMeme(newTedTalk: any) {
		this.setState({
			currentTedTalk: newTedTalk
		})
	}

	// GET memes
	private fetchTedTalks(speaker?: any) {
		let url = apiUrl + "/ted"
		if (!!speaker) {
			url += "/speaker?=" + speaker
		}
        fetch(url, {
			method: 'GET',
        })
        .then(res => {
			return res.json()
			})
        .then(json => {
			this.setState({
				tedTalks: json
			})
        });
	}

	// Sets file list
	private handleFileUpload(fileList: any) {
		this.setState({
			uploadFileList: fileList.target.files
		})
	}

	// POST meme
	private uploadMeme() {
		const titleInput = document.getElementById("meme-title-input") as HTMLInputElement
		const tagInput = document.getElementById("meme-tag-input") as HTMLInputElement
		const imageFile = this.state.uploadFileList[0]

		if (titleInput === null || tagInput === null || imageFile === null) {
			return;
		}

		const title = titleInput.value
		const tag = tagInput.value
		const url = "http://phase2apitest.azurewebsites.net/api/meme/upload"

		const formData = new FormData()
		formData.append("Title", title)
		formData.append("Tags", tag)
		formData.append("image", imageFile)

		fetch(url, {
			body: formData,
			headers: {'cache-control': 'no-cache'},
			method: 'POST'
		})
        .then((response : any) => {
			if (!response.ok) {
				// Error State
				alert(response.statusText)
			} else {
				location.reload()
			}
		  })
	}
}

export default App;
